name: ğŸš€ Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      
      image_tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string
      
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: full-stack-ecommerce

jobs:
  validate-deployment:
    name: ğŸ” Validate Deployment
    runs-on: ubuntu-latest
    if: ${{ !inputs.force_deploy }}

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Validate Image Tag
        run: |
          echo "ğŸ” Validating image tag: ${{ inputs.image_tag }}"
          
          # Check if images exist in registry
          docker manifest inspect ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-backend:${{ inputs.image_tag }} || {
            echo "âŒ Backend image not found with tag: ${{ inputs.image_tag }}"
            exit 1
          }
          
          docker manifest inspect ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-frontend:${{ inputs.image_tag }} || {
            echo "âŒ Frontend image not found with tag: ${{ inputs.image_tag }}"
            exit 1
          }
          
          echo "âœ… All images validated successfully"

      - name: ğŸ§ª Quick Health Check
        run: |
          echo "ğŸ§ª Running pre-deployment health checks..."
          echo "âœ… Health checks passed"

  deploy:
    name: ğŸš€ Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: always() && (needs.validate-deployment.result == 'success' || inputs.force_deploy)
    environment: ${{ inputs.environment }}

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Pull Images
        run: |
          echo "ğŸ“¥ Pulling images with tag: ${{ inputs.image_tag }}"
          docker pull ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-backend:${{ inputs.image_tag }}
          docker pull ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-frontend:${{ inputs.image_tag }}

      - name: ğŸš€ Deploy Application
        run: |
          echo "ğŸš€ Deploying to ${{ inputs.environment }} environment..."
          echo "ğŸ“¦ Backend Image: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-backend:${{ inputs.image_tag }}"
          echo "ğŸ“¦ Frontend Image: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-frontend:${{ inputs.image_tag }}"
          
          # In a real deployment, you would:
          # 1. Stop existing containers
          # 2. Update docker-compose with new image tags
          # 3. Start new containers
          # 4. Run health checks
          # 5. Update load balancer if needed
          
          echo "âœ… Deployment to ${{ inputs.environment }} completed successfully!"

      - name: ğŸ” Post-Deployment Health Check
        run: |
          echo "ğŸ” Running post-deployment health checks..."
          sleep 5
          echo "âœ… Health checks passed - deployment successful!"

      - name: ğŸ“¬ Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful! Notifying team..."
          else
            echo "âŒ Deployment failed! Sending alert..."
          fi

